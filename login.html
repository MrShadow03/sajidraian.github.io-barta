<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BARTA Login</title>
  <link rel="stylesheet" href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css" />
  <link rel="stylesheet" href="style.css" />
</head>
<body class="login-page">
  <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
    <span class="theme-icon" id="themeIcon">ðŸŒ™</span>
  </button>
  
  <main class="login-panel">
    <div class="login-brand">
      <i class="las la-comments brand-icon" style="font-size: 40px;"></i>
      <h2>BARTA</h2>
    </div>

    <h3 class="login-title">Sign in to BARTA</h3>
    <p class="login-desc">Enter your credentials to continue</p>

    <label class="field">
      <input class="input" type="text" placeholder="Username" id="username" required aria-label="Username" autocomplete="username" />
    </label>

    <label class="field">
      <input class="input" type="password" placeholder="Password" id="password" required aria-label="Password" autocomplete="current-password" />
    </label>

    <div class="actions">
      <button id="loginBtn" class="btn btn-primary">Login</button>
    </div>

    <p class="small">Don't have an account? <a href="register.html" style="color: var(--accent);">Register here</a></p>
  </main>

  <script>
    // Dynamic API URL - works for both local and Railway deployment
    const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:3000/api'
      : `${window.location.protocol}//${window.location.host}/api`;
    
    console.log('API URL:', API_URL);
    
    // Sound Effects System
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(type) {
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      
      if (type === 'click') {
        oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.1);
      } else if (type === 'error') {
        oscillator.frequency.setValueAtTime(300, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.2);
      } else if (type === 'success') {
        oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
        oscillator.frequency.setValueAtTime(800, audioCtx.currentTime + 0.05);
        oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.08, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.2);
      } else if (type === 'toggle') {
        oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
        oscillator.frequency.setValueAtTime(900, audioCtx.currentTime + 0.05);
        gainNode.gain.setValueAtTime(0.08, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.15);
      }
    }
    
    // Theme toggle functionality
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const html = document.documentElement;
    
    // Load saved theme or default to dark
    const savedTheme = localStorage.getItem('theme') || 'dark';
    html.setAttribute('data-theme', savedTheme);
    themeIcon.innerHTML = savedTheme === 'light' ? '<i class="las la-moon"></i>' : '<i class="las la-sun"></i>';
    
    themeToggle.addEventListener('click', () => {
      playSound('toggle');
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      themeIcon.innerHTML = newTheme === 'light' ? '<i class="las la-moon"></i>' : '<i class="las la-sun"></i>';
    });
    
    // Login functionality
    const loginBtn = document.getElementById('loginBtn');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');

    loginBtn.addEventListener('click', async () => {
      const username = usernameInput.value.trim();
      const password = passwordInput.value;
      
      // Clear previous error states
      usernameInput.style.borderColor = '';
      passwordInput.style.borderColor = '';
      
      if (!username) {
        usernameInput.style.borderColor = '#ff4444';
        usernameInput.focus();
        playSound('error');
        showToast('Please enter your username');
        return;
      }
      
      if (!password) {
        passwordInput.style.borderColor = '#ff4444';
        passwordInput.focus();
        playSound('error');
        showToast('Please enter your password');
        return;
      }
      
      // Show loading state
      loginBtn.disabled = true;
      loginBtn.textContent = 'Logging in...';
      loginBtn.style.opacity = '0.6';
      loginBtn.style.cursor = 'not-allowed';
      
      try {
        const response = await fetch(`${API_URL}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          playSound('success');
          showToast('Login successful!', 'success');
          
          // Store session
          localStorage.setItem('sessionId', data.sessionId);
          localStorage.setItem('userId', data.user.id);
          localStorage.setItem('username', data.user.username);
          localStorage.setItem('userPhoto', data.user.photo);
          
          setTimeout(() => {
            window.location.href = 'chat_box.html';
          }, 800);
        } else {
          playSound('error');
          showToast(data.error || 'Login failed');
          loginBtn.disabled = false;
          loginBtn.textContent = 'Login';
          loginBtn.style.opacity = '1';
          loginBtn.style.cursor = 'pointer';
        }
      } catch (err) {
        playSound('error');
        showToast('Server error. Please make sure the server is running.');
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
        loginBtn.style.opacity = '1';
        loginBtn.style.cursor = 'pointer';
      }
    });
    
    // Toast notification function
    function showToast(message, type = 'error') {
      const toast = document.createElement('div');
      toast.textContent = message;
      const bgColor = type === 'success' 
        ? 'linear-gradient(135deg, #4caf50, #45a049)' 
        : 'linear-gradient(135deg, #ff4444, #cc0000)';
      
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${bgColor};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        font-size: 14px;
        animation: slideIn 0.3s ease;
      `;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // Add animation styles
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
    
    // Enable Enter key
    passwordInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') loginBtn.click();
    });
    
    usernameInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') passwordInput.focus();
    });
  </script>
</body>
</html>
